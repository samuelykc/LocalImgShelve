<html>
<head>
<meta charset="UTF-8">
<title>Local Image Shelve</title>
<style>
    body {
        background-color: #3c3f41;
    }
    .HeaderP {
        color: white;
    }
    .SquareIcon {
        width: 250px;
        height: 280px;
        display: inline-block;
        margin: 10px;
        padding: 0px 10px;
        text-align: center;
        vertical-align: middle;
        border-radius: 10px;
        background-color: #919191;
        cursor: pointer;
        position: relative;
    }
    .SquareIconP {
        height: 42px;
        padding-bottom: 10px;
    }
    .SquareIconPFolder {
        font-weight: bold;
    }
    .SquareIconImg {
        height: 200px;
    }
    img {
        max-width: 100%;
        max-height: 100%;
    }
</style>
</head>
<body></body>

<script src="LocalImgShelveJson.txt">
// records = [
// 	{
// 		folder:"Comic",
// 		contents:
// 		[
// 			{
// 				folder:"Comic1",
// 				contents:
// 				[
// 					"000.jpg",
// 					"001.jpg",
// 					"002.jpg",
// 					"003.jpg"
// 				]
// 			},
// 			{
// 				folder:"Comic2",
// 				contents:
// 				[
// 					"001.jpg",
// 					"002.jpg",
// 					"003.jpg"
// 				]
// 			}
// 		]
// 	},
// 	{

// 	}
// ];
</script>

<script>
    let path = [];

    function pathChanged()
    {
        //clear body
        document.body.innerHTML = '';

        let headerP = document.createElement("p");
        headerP.innerHTML = "Path: " + path.join('/');
        headerP.classList.add('HeaderP');
        document.body.appendChild(headerP);

        //dig into the designated level accroding to current path
        let recordPos = records;
        for (const p of path) {
            const nextPos = recordPos.find(element => element.folder === p);
            recordPos = nextPos.contents;
        }

        //print folders in this level
        for (const record of recordPos) {
            let div = document.createElement("div");
            div.classList.add('SquareIcon');
            document.body.appendChild(div);

            let div_p = document.createElement("div");
            div_p.classList.add('SquareIconP');
            if (!record.contents || typeof record.contents[0] !== "string") {
                div_p.classList.add('SquareIconPFolder');
            }
            div.appendChild(div_p);

            let p = document.createElement("p");
            p.innerHTML = record.folder;
            div_p.appendChild(p);

            let div_img = document.createElement("div");
            div_img.classList.add('SquareIconImg');
            div.appendChild(div_img);

            // find first image in this folder (non-recursive)
            let firstImage = record.contents && record.contents.find(c => typeof c === "string");
            if(firstImage)
            {
                let img = document.createElement("img");
                img.src = path.join('/') + (path.length > 0 ? '/' : '') + record.folder + '/' + encodeURIComponent(firstImage);
                div_img.appendChild(img);
            }

            // mouse actions
            div.addEventListener('mousedown', e =>
            {
                e.preventDefault();
                switch(e.button)
                {
                    case 0:
                        // Left click: open folder/gallery
                        browse(record);
                        break;
                    case 1:
                        // Middle click: force open gallery
                        browseAsGallery(record);
                        break;
                    case 2:
                        // Right click: open all images recursively
                        let allImages = collectImagesRecursive(record, "");
                        if(allImages.length > 0)
                        {
                            let win = window.open("LocalImgReader.html?" +
                                "imgList=" + encodeURIComponent(allImages.join(':')) +
                                "&path=" + encodeURIComponent(path.join('/') + (path.length>0?'/':'') + record.folder)); //path prefix for files
                            win.focus();
                        }
                        break;
                }
            });
        }
    }

    function browse(record)
    {
        // reject empty folder
        if(!record.contents || record.contents.length <= 0) return;

        // open gallery
        if(record.contents && (typeof record.contents[0])==="string")
        {
            browseAsGallery(record);
        }
        // open folder
        else
        {
            path.push(record.folder);
            pathChanged();
        }
    }

    function browseAsGallery(record)
    {
        const fileList = record.contents.filter(item => typeof item === 'string'); // extract file names (filter out folders)

        var win = window.open("LocalImgReader.html?"+
            "imgList=" + encodeURIComponent(fileList.join(':')) + //list of file names
            "&path=" + encodeURIComponent(path.join('/') + (path.length>0?'/':'') + record.folder)); //path prefix for files
        win.focus();
    }

    // recursively collect all images
    function collectImagesRecursive(record, prefixPath) {
        let images = [];
        if(!record.contents) return images;

        for(let item of record.contents)
        {
            if (typeof item === "string") {
                images.push(prefixPath + '/' + item);
            } else if (typeof item === "object" && item.folder) {
                images = images.concat(collectImagesRecursive(item, prefixPath + '/' + item.folder));
            }
        }
        return images;
    }

    function goBack()
    {
        path.pop();
        pathChanged();
    }

    //------------- paging -------------
    document.body.onkeydown = function(e)
    {
        switch(e.key)
        {
            case "GoBack": case "Backspace":
                e.preventDefault();
                goBack();
                break;
        }
    };

    window.addEventListener("mouseup", e => {
        switch(event.button)
        {
            case 3:
                e.preventDefault();
                goBack();
                break;
            case 4:
                break;
        }
    });

    pathChanged();
</script>
</html>