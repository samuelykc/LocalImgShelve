<html>
<head>
<meta charset="UTF-8">
<title>Local Image Shelve</title>
<style>
    body {
        background-color: #2b2d31;
        font-family: "Segoe UI", Roboto, sans-serif;
        margin: 0;
        padding: 20px;
        color: white;
    }

    /* Breadcrumb header */
    .HeaderP {
        font-size: 16px;
        margin-bottom: 20px;
        opacity: 0.8;
    }

    /* Grid layout */
    .shelf-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
    }

    /* Folder/Image card */
    .SquareIcon {
        background-color: #3a3d42;
        border-radius: 12px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .SquareIcon:hover {
        transform: translateY(-4px);
        box-shadow: 0 6px 14px rgba(0,0,0,0.4);
    }

    /* Thumbnail container */
    .SquareIconImg {
        flex: 1;
        background-color: #222;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .SquareIconImg img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }

    /* Name overlay */
    .SquareIconP {
        padding: 10px;
        font-size: 14px;
        font-weight: 500;
        background: rgba(0,0,0,0.25);
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .SquareIconPFolder {
        font-weight: bold;
        color: #ffd479;
    }
</style>
</head>
<body></body>

<script src="LocalImgShelveJson.txt">
// records = [
//  {
//      folder:"Comic",
//      contents:
//      [
//          {
//              folder:"Comic1",
//              contents:
//              [
//                  "000.jpg",
//                  "001.jpg",
//                  "002.jpg",
//                  "003.jpg"
//              ]
//          },
//          {
//              folder:"Comic2",
//              contents:
//              [
//                  "001.jpg",
//                  "002.jpg",
//                  "003.jpg"
//              ]
//          }
//      ]
//  },
//  {

//  }
// ];
</script>

<script>
    let path = [];

    function pathChanged()
    {
        // clear body
        document.body.innerHTML = '';

        // add base elements
        let headerP = document.createElement("p");
        headerP.innerHTML = "Path: " + path.join('/');
        headerP.classList.add('HeaderP');
        document.body.appendChild(headerP);

        let gridFolder = document.createElement("div");
        gridFolder.classList.add("shelf-grid");
        document.body.appendChild(gridFolder);

        let gridGallery = document.createElement("div");
        gridGallery.classList.add("shelf-grid");
        document.body.appendChild(gridGallery);

        // dig into the designated level accroding to current path
        let recordPos = records;
        for (const p of path) {
            const nextPos = recordPos.find(element => element.folder === p);
            recordPos = nextPos.contents;
        }

        // print folders in this level
        for (const record of recordPos) {
            let div = document.createElement("div");
            div.classList.add('SquareIcon');

            let div_p = document.createElement("div");
            div_p.classList.add('SquareIconP');
            if (!record.contents || typeof record.contents[0] !== "string") {
                div_p.classList.add('SquareIconPFolder');
            }
            div.appendChild(div_p);

            let p = document.createElement("p");
            p.innerHTML = record.folder;
            div_p.appendChild(p);

            let div_img = document.createElement("div");
            div_img.classList.add('SquareIconImg');
            div.appendChild(div_img);

            // find first image in this folder (non-recursive)
            let firstImage = record.contents && record.contents.find(c => typeof c === "string");
            if(firstImage)
            {
                let img = document.createElement("img");
                img.src = path.join('/') + (path.length>0? '/': '') + record.folder + '/' + encodeURIComponent(firstImage);
                div_img.appendChild(img);
            }

            // mouse actions
            div.addEventListener('mousedown', e =>
            {
                e.preventDefault();
                switch(e.button)
                {
                    case 0:
                        // Left click: open folder/gallery
                        browse(record);
                        break;
                    case 1:
                        // Middle click: force open gallery
                        browseAsGallery(record);
                        break;
                    case 2:
                        // Right click: open all images recursively
                        let allImages = collectImagesRecursive(record, "");
                        if(allImages.length > 0)
                        {
                            let win = window.open("LocalImgReader.html?" +
                                "imgList=" + encodeURIComponent(allImages.join(':')) +
                                "&path=" + encodeURIComponent(path.join('/') + (path.length>0?'/':'') + record.folder)); //path prefix for files
                            win.focus();
                        }
                        break;
                }
            });

            // append to grid depending on whether any image exists in the folder
            if(firstImage) gridGallery.appendChild(div);
            else gridFolder.appendChild(div);
        }
    }

    function browse(record)
    {
        // reject empty folder
        if(!record.contents || record.contents.length <= 0) return;

        // open gallery
        if(record.contents && (typeof record.contents[0])==="string")
        {
            browseAsGallery(record);
        }
        // open folder
        else
        {
            path.push(record.folder);
            pathChanged();
        }
    }

    function browseAsGallery(record)
    {
        const fileList = record.contents.filter(item => typeof item === 'string'); // extract file names (filter out folders)

        var win = window.open("LocalImgReader.html?"+
            "imgList=" + encodeURIComponent(fileList.join(':')) + //list of file names
            "&path=" + encodeURIComponent(path.join('/') + (path.length>0?'/':'') + record.folder)); //path prefix for files
        win.focus();
    }

    // recursively collect all images
    function collectImagesRecursive(record, prefixPath) {
        let images = [];
        if(!record.contents) return images;

        for(let item of record.contents)
        {
            if (typeof item === "string") {
                images.push(prefixPath + '/' + item);
            } else if (typeof item === "object" && item.folder) {
                images = images.concat(collectImagesRecursive(item, prefixPath + '/' + item.folder));
            }
        }
        return images;
    }

    function goBack()
    {
        path.pop();
        pathChanged();
    }

    //------------- paging -------------
    document.body.onkeydown = function(e)
    {
        switch(e.key)
        {
            case "GoBack": case "Backspace":
                e.preventDefault();
                goBack();
                break;
        }
    };

    window.addEventListener("mouseup", e => {
        switch(event.button)
        {
            case 3:
                e.preventDefault();
                goBack();
                break;
            case 4:
                break;
        }
    });

    pathChanged();
</script>
</html>