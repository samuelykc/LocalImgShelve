<html>
<head>
    <meta charset="UTF-8">
    <title>Local Image Reader</title>
    <style>
        body {
            background-color: #1a1a1a;
            margin: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            color: white;
            font-family: sans-serif;
            user-select: none;
        }

        #viewer {
            position: relative;
            width: 100%;
            height: calc(100vh - 120px); /* Adjusted height to make space for the filmstrip */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .viewer-img {
            max-width: 95%;
            max-height: 95%;
            transition: opacity 0.3s ease;
            object-fit: contain;
        }

        #controls {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 14px;
            opacity: 0.7;
        }

        .nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 48px;
            color: white;
            background: rgba(0, 0, 0, 0.3);
            border: none;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            transition: background 0.2s;
        }
        .nav-btn:hover {
            background: rgba(0, 0, 0, 0.6);
        }
        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }
        #prevBtn { left: 20px; }
        #nextBtn { right: 20px; }

        #modeBtn {
            position: absolute;
            top: 0px;
            right: 15px;
            background: rgba(0,0,0,0.3);
            color: white;
            border: none;
            padding: 8px 14px;
            font-size: 14px;
            border-radius: 6px;
            cursor: pointer;
        }
        #modeBtn:hover {
            background: rgba(0,0,0,0.6);
        }
        
        #filmstrip {
            position: relative;
            width: 100%;
            height: 100px;
            background: rgba(0, 0, 0, 0.2);
            padding: 10px 0;
            white-space: nowrap;
            overflow-x: auto;
            overflow-y: hidden; /* Hides vertical scrollbar */
            display: flex;
            align-items: center;
            gap: 10px;
            box-sizing: border-box;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        /* [filmstrip] horizontal scrollbar */
        #filmstrip::-webkit-scrollbar {
            height: 8px;
        }
        #filmstrip::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        #filmstrip::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: content-box;
        }
        #filmstrip { /* Fallback for Firefox */
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.3) rgba(255, 255, 255, 0.1);
        }

        /* [filmstrip] thumbnail */
        .thumbnail {
            width: auto;
            height: 80px;
            object-fit: contain;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
            filter: grayscale(100%);
            opacity: 0.6;
        }
        .thumbnail:hover {
            transform: scale(1.1);
            filter: grayscale(0%);
            opacity: 1;
        }
        .thumbnail.active {
            border-color: #007bff;
            filter: grayscale(0%);
            opacity: 1;
            transform: scale(1.1);
        }
    </style>
</head>

<body>
    <div id="viewer">
        <button id="prevBtn" class="nav-btn">&#10094;</button>
        <img id="img1" class="viewer-img" src="" alt="Image">
        <img id="img2" class="viewer-img" src="" alt="Image" style="display:none;">
        <button id="nextBtn" class="nav-btn">&#10095;</button>
        <div id="controls"></div>
        <button id="modeBtn">(mode)</button>
    </div>
    
    <div id="filmstrip"></div>

</body>

<script>
    // Parse URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    let imageList = decodeURIComponent(urlParams.get('imgList')).split(':');
    let path = decodeURIComponent(urlParams.get('path'));

    let currentIndex = 0;
    let currentDisplayCount = 1;
    let mode = 3; // 0=Single, 1=Double, 2=Double Inverted, 3=Smart

    // Find & initialize UI elements
    const img1 = document.getElementById('img1');
    const img2 = document.getElementById('img2');
    const filmstripEl = document.getElementById('filmstrip');

    const modeBtn = document.getElementById('modeBtn');
    modeBtn.innerText = getModeLabel(mode);

    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const controlsEl = document.getElementById('controls');

    // Transverse
    prevBtn.addEventListener('click', goPrev);
    nextBtn.addEventListener('click', goNext);

    document.addEventListener('keydown', e => {
        if(e.key === 'ArrowLeft') goPrev();
        if(e.key === 'ArrowRight') goNext();
    });

    document.addEventListener('wheel', e => {
        e.preventDefault(); // Prevent default browser scroll behavior

        if(e.deltaY < 0) goPrev();
        else if (e.deltaY > 0) goNext();
    }, { passive: false }); // `passive: false` is important to allow e.preventDefault() to work

    // Mode toggle
    modeBtn.addEventListener('click', () => {
        mode = (mode + 1) % 4;
        modeBtn.textContent = getModeLabel(mode);
        updateViewer(currentIndex);
    });

    // Initialize
    initFilmstrip();
    updateViewer(currentIndex);


    async function updateViewer(index) {
        if (index < 0) index = 0;
        if (index >= imageList.length) index = imageList.length - 1;
        currentIndex = index;

        img1.style.opacity = 0;
        img2.style.opacity = 0;

        await showByMode(mode);
        updateFilmstrip();
    }

    
    function initFilmstrip()
    {
        // Clear any existing thumbnails
        filmstripEl.innerHTML = '';

        // Append thumbnails
        imageList.forEach((imageName, index) => {
            const thumbnail = document.createElement('img');
            thumbnail.classList.add('thumbnail');
            thumbnail.src = `${path}/${imageName}`;
            thumbnail.dataset.index = index;
            thumbnail.alt = `Thumbnail for image ${index + 1}`;
            thumbnail.addEventListener('click', () => { updateViewer(index); });
            filmstripEl.appendChild(thumbnail);
        });
    }
    function updateFilmstrip()
    {
        // Remove active class from all thumbnails
        document.querySelectorAll('.thumbnail').forEach(thumb => {
            thumb.classList.remove('active');
            thumb.style.transform = 'scale(1.0)';
        });
        
        // Add active class to the current thumbnail (img1)
        const currentThumbnail = document.querySelector(`.thumbnail[data-index='${currentIndex}']`);
        if(currentThumbnail)
        {
            currentThumbnail.classList.add('active');

            // Scroll to the active thumbnail
            const filmstripScroll = filmstripEl.scrollWidth > filmstripEl.clientWidth;
            if(filmstripScroll)
            {
                filmstripEl.scroll({
                    left: currentThumbnail.offsetLeft - (filmstripEl.clientWidth / 2) + (currentThumbnail.clientWidth / 2),
                    behavior: 'smooth'
                });
            }
        }
        
        // Add active class to the current thumbnail (img2)
        if(currentDisplayCount > 1)
        {
            const currentThumbnail2 = document.querySelector(`.thumbnail[data-index='${currentIndex+1}']`);
            if(currentThumbnail2) currentThumbnail2.classList.add('active');
        }
    }

    async function showByMode(viewMode)
    {
        if(viewMode === 0) // Single page
        {
            currentDisplayCount = 1;
            img2.style.display = 'none';
            setImage(img1, currentIndex, () => img1.style.opacity = 1);
            controlsEl.textContent = `${currentIndex + 1} / ${imageList.length}`;

            preloadImage(currentIndex + 1);
        }
        else if(viewMode === 1) // Double page (normal)
        { 
            currentDisplayCount = 2;
            img2.style.display = '';
            setImage(img1, currentIndex, () => img1.style.opacity = 1);
            setImage(img2, currentIndex + 1, () => img2.style.opacity = 1);
            controlsEl.textContent = `${currentIndex + 1}-${Math.min(currentIndex + 2, imageList.length)} / ${imageList.length}`;

            preloadImage(currentIndex + 2);
            preloadImage(currentIndex + 3);
        }
        else if(viewMode === 2) // Double page (inverted)
        {
            currentDisplayCount = 2;
            img2.style.display = '';
            setImage(img2, currentIndex, () => img2.style.opacity = 1);
            setImage(img1, currentIndex + 1, () => img1.style.opacity = 1);
            controlsEl.textContent = `${currentIndex + 1}-${Math.min(currentIndex + 2, imageList.length)} / ${imageList.length}`;

            preloadImage(currentIndex + 2);
            preloadImage(currentIndex + 3);
        }
        else if(viewMode === 3) // Smart mode: decide layout after reading dimensions
        {
            // Load current & next to check orientation
            return Promise.all([
                getImageSize(`${path}/${imageList[currentIndex]}`),
                getImageSize(currentIndex + 1 < imageList.length ? `${path}/${imageList[currentIndex+1]}` : null)
            ]).then(([curr, next]) => {

                if(curr && next &&
                    curr.height >= curr.width && next.height >= next.width)
                    showByMode(2); // Double inverted
                else
                    showByMode(0); // Single
            });
            return;
        }

        updatePagination();
    }

    function getImageSize(src) {
        return new Promise(resolve => {
            if (!src) return resolve(null);
            const img = new Image();
            img.onload = () => resolve({ width: img.width, height: img.height });
            img.onerror = () => resolve(null);
            img.src = src;
        });
    }

    function setImage(imgEl, index, onLoad) {
        if (index >= 0 && index < imageList.length) {
            imgEl.src = `${path}/${imageList[index]}`;
            imgEl.onload = onLoad;
        } else {
            imgEl.src = '';
        }
    }
    function updatePagination()
    {
        prevBtn.disabled = !hasPrev();
        nextBtn.disabled = !hasNext();
    }

    function preloadImage(index) {
        if (index >= 0 && index < imageList.length) {
            const preImg = new Image();
            preImg.src = `${path}/${imageList[index]}`;
        }
    }

    function goPrev()
    {
        if(!hasPrev()) return;

        if(mode === 0) updateViewer(currentIndex - 1);
        else if(mode === 1 || mode === 2) updateViewer(currentIndex - 2);
        else if(mode === 3) getSmartStep(false).then(step => { updateViewer(currentIndex - step); });
    }
    function goNext()
    {
        if(!hasNext()) return;

        if(mode === 0) updateViewer(currentIndex + 1);
        else if(mode === 1 || mode === 2) updateViewer(currentIndex + 2);
        else if(mode === 3) getSmartStep(true).then(step => { updateViewer(currentIndex + step); });
    }

    function getSmartStep(isNext)
    {
        if(isNext)
        {
            return Promise.resolve(currentDisplayCount);
        }
        else
        {
            // Load previous 2 images to check orientation
            return Promise.all([
                getImageSize(currentIndex-1 >= 0? `${path}/${imageList[currentIndex-1]}` : null),
                getImageSize(currentIndex-2 >= 0? `${path}/${imageList[currentIndex-2]}` : null)
            ]).then(([pre1, pre2]) => {
                if(pre1 && pre2 &&
                    pre1.height >= pre1.width && pre2.height >= pre2.width) return 2;
                return 1;
            });
        }
    }
    function hasPrev() { return currentIndex > 0; }
    function hasNext() { return currentIndex+currentDisplayCount < imageList.length; }

    function getModeLabel(mode)
    {
        switch(mode)
        {
            case 0: return '📄Single';
            case 1: return '📖Double';
            case 2: return '📖Inverted';
            case 3: return '🤖Smart';
            default: return 'Invalid';
        }
    }
</script>
</html>